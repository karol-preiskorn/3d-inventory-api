#!/usr/bin/bash
# File:        /.husky/pre-commit
# Description: lint, format, type check and version bump before commit
# 2023-11-26  C2RLO    Initial
# 2025-09-20  Updated   Added comprehensive linting and formatting

. "$(dirname "$0")/_/husky.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üîç Running pre-commit checks...${NC}"

# Function to check if files exist
check_files() {
  if [ -z "$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|js)$')" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  No TypeScript/JavaScript files to check${NC}"
    return 1
  fi
  return 0
}

# Check if there are staged TypeScript/JavaScript files
if check_files; then
  echo -e "${BLUE}üìù Found staged TypeScript/JavaScript files${NC}"

  # Run lint-staged for staged files
  echo -e "${BLUE}üßπ Running lint-staged...${NC}"
  npx lint-staged

  if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå Lint-staged failed. Please fix the issues and try again.${NC}"
    exit 1
  fi

  echo -e "${GREEN}‚úÖ Lint-staged completed successfully${NC}"
else
  echo -e "${YELLOW}‚è≠Ô∏è  Skipping lint checks (no relevant files staged)${NC}"
fi

# Run type checking on entire project
echo -e "${BLUE}üîç Running TypeScript type check...${NC}"
npm run check:type

if [ $? -ne 0 ]; then
  echo -e "${RED}‚ùå TypeScript type check failed. Please fix the errors and try again.${NC}"
  exit 1
fi

echo -e "${GREEN}‚úÖ TypeScript type check passed${NC}"

# Version bump (only for main branch commits)
BRANCH=$(git branch --show-current)
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
  echo -e "${BLUE}üì¶ Updating version (patch)...${NC}"
  npm --no-git-tag-version version patch
  git add package.json
  echo -e "${GREEN}‚úÖ Version updated${NC}"
else
  echo -e "${YELLOW}‚è≠Ô∏è  Skipping version bump (not on main branch)${NC}"
fi

echo -e "${GREEN}üéâ All pre-commit checks passed!${NC}"
