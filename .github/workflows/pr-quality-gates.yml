name: PR Quality Gates

# Validates all quality gates defined in PULL_REQUEST_TEMPLATE.md
# Ensures PRs meet project standards before merge

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
      - develop

env:
  NODE_VERSION: '22.x'
  COVERAGE_THRESHOLD: 80
  MAX_WARNINGS: 0

permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write

jobs:
  # ================================================================================
  # JOB 1: Code Quality Standards Validation
  # ================================================================================
  code-quality:
    name: âœ… Code Quality Standards
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event.pull_request.draft == false

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ¨ Prettier formatting check
        run: npm run prettier
        continue-on-error: false

      - name: ğŸ” ESLint validation
        run: npm run lint:check
        continue-on-error: false

      - name: ğŸ“˜ TypeScript strict mode compliance
        run: npm run check:type
        continue-on-error: false

      - name: ğŸ“Š Generate quality report
        if: always()
        run: |
          echo "### âœ… Code Quality Standards" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Prettier formatting: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ESLint validation: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… TypeScript strict mode: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Compliance**: All code quality standards met" >> $GITHUB_STEP_SUMMARY

  # ================================================================================
  # JOB 2: Test Coverage Validation
  # ================================================================================
  test-coverage:
    name: ğŸ§ª Test Coverage (â‰¥${{ env.COVERAGE_THRESHOLD }}%)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: code-quality

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ§ª Run tests with coverage
        run: npm run test:coverage
        env:
          CI: true
          NODE_ENV: test

      - name: ğŸ“Š Verify coverage threshold
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "Test coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
            echo "âŒ Coverage $COVERAGE% is below threshold $COVERAGE_THRESHOLD%"
            exit 1
          fi
          echo "âœ… Coverage $COVERAGE% meets threshold $COVERAGE_THRESHOLD%"

      - name: ğŸ“ˆ Coverage report summary
        if: always()
        run: |
          echo "### ğŸ§ª Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          cat coverage/coverage-summary.json | jq '.total' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          if (( $(echo "$COVERAGE >= $COVERAGE_THRESHOLD" | bc -l) )); then
            echo "âœ… **Coverage**: $COVERAGE% (Threshold: â‰¥$COVERAGE_THRESHOLD%)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Coverage**: $COVERAGE% (Threshold: â‰¥$COVERAGE_THRESHOLD%)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“¤ Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ github.event.pull_request.number }}
          path: coverage/
          retention-days: 30

      - name: ğŸ’¬ Comment coverage on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            const total = coverage.total;

            const coveragePct = total.lines.pct;
            const threshold = ${{ env.COVERAGE_THRESHOLD }};
            const passed = coveragePct >= threshold;

            const icon = passed ? 'âœ…' : 'âŒ';
            const status = passed ? 'PASSED' : 'FAILED';

            const body = `## ${icon} Test Coverage Report

            | Metric | Coverage | Status |
            |--------|----------|--------|
            | Statements | ${total.statements.pct}% | ${total.statements.pct >= threshold ? 'âœ…' : 'âŒ'} |
            | Branches | ${total.branches.pct}% | ${total.branches.pct >= 75 ? 'âœ…' : 'âŒ'} |
            | Functions | ${total.functions.pct}% | ${total.functions.pct >= 85 ? 'âœ…' : 'âŒ'} |
            | Lines | ${total.lines.pct}% | ${total.lines.pct >= threshold ? 'âœ…' : 'âŒ'} |

            **Overall Status**: ${status} (Threshold: â‰¥${threshold}%)

            <details>
            <summary>ğŸ“Š Detailed Coverage</summary>

            \`\`\`json
            ${JSON.stringify(total, null, 2)}
            \`\`\`
            </details>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ================================================================================
  # JOB 3: Security Validation
  # ================================================================================
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: code-quality

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ” NPM Security Audit
        run: |
          npm audit --audit-level=moderate --json > audit-results.json || true
          VULNERABILITIES=$(cat audit-results.json | jq '.metadata.vulnerabilities')
          echo "Vulnerabilities found: $VULNERABILITIES"

      - name: ğŸ” Check for hardcoded secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

      - name: ğŸ“Š Security report summary
        if: always()
        run: |
          echo "### ğŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f audit-results.json ]; then
            HIGH=$(cat audit-results.json | jq '.metadata.vulnerabilities.high // 0')
            CRITICAL=$(cat audit-results.json | jq '.metadata.vulnerabilities.critical // 0')

            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
              echo "âŒ **Status**: FAILED (Critical or High vulnerabilities found)" >> $GITHUB_STEP_SUMMARY
              exit 1
            else
              echo "âœ… **Status**: PASSED (No critical/high vulnerabilities)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  # ================================================================================
  # JOB 4: Build Validation
  # ================================================================================
  build:
    name: ğŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [code-quality, test-coverage]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ—ï¸ Production build
        run: npm run build
        env:
          NODE_ENV: production

      - name: âœ… Verify build artifacts
        run: |
          echo "Checking build artifacts..."
          ls -la dist/

          # Verify main entry point exists
          if [ ! -f "dist/src/main.js" ]; then
            echo "âŒ Build failed: main.js not found"
            exit 1
          fi

          # Verify api.yaml was copied
          if [ ! -f "dist/api.yaml" ]; then
            echo "âŒ Build failed: api.yaml not found"
            exit 1
          fi

          echo "âœ… Build artifacts verified successfully"

      - name: ğŸ“Š Build report summary
        if: always()
        run: |
          echo "### ğŸ—ï¸ Build Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… TypeScript compilation: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build artifacts: VERIFIED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Status**: Production build successful" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ github.event.pull_request.number }}
          path: dist/
          retention-days: 7

  # ================================================================================
  # JOB 5: Instruction File Compliance Check
  # ================================================================================
  instruction-compliance:
    name: ğŸ“š Instruction File Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Check file organization compliance
        run: |
          echo "Checking file organization..."

          # Verify no unauthorized files in root
          UNAUTHORIZED_FILES=$(find . -maxdepth 1 -type f \
            ! -name "README.md" \
            ! -name "DEVELOPMENT.md" \
            ! -name "AGENTS.md" \
            ! -name "SECURITY.md" \
            ! -name "package.json" \
            ! -name "package-lock.json" \
            ! -name "tsconfig.json" \
            ! -name ".*" \
            -name "*.md" -o -name "*.sh" -o -name "*.ts" -o -name "*.js" | wc -l)

          if [ "$UNAUTHORIZED_FILES" -gt 0 ]; then
            echo "âŒ Found unauthorized files in root directory"
            echo "Only README.md, DEVELOPMENT.md, AGENTS.md, and SECURITY.md allowed"
            find . -maxdepth 1 -type f -name "*.md" ! -name "README.md" ! -name "DEVELOPMENT.md" ! -name "AGENTS.md" ! -name "SECURITY.md"
            exit 1
          fi

          echo "âœ… File organization: COMPLIANT"

      - name: ğŸ“Š Compliance report summary
        if: always()
        run: |
          echo "### ğŸ“š Instruction File Compliance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… File organization: COMPLIANT" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Root directory: CLEAN (only essential files)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Compliance**: Follows [file-organization.instructions.md](.github/instructions/file-organization.instructions.md)" >> $GITHUB_STEP_SUMMARY

  # ================================================================================
  # JOB 6: Final PR Status Check
  # ================================================================================
  pr-status:
    name: ğŸ“‹ PR Quality Gate Status
    runs-on: ubuntu-latest
    needs: [code-quality, test-coverage, security, build, instruction-compliance]
    if: always()

    steps:
      - name: âœ… All quality gates passed
        if: needs.code-quality.result == 'success' && needs.test-coverage.result == 'success' && needs.security.result == 'success' && needs.build.result == 'success' && needs.instruction-compliance.result == 'success'
        run: |
          echo "### âœ… All PR Quality Gates PASSED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Gate | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality Standards | âœ… PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Coverage (â‰¥80%) | âœ… PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | âœ… PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Verification | âœ… PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| Instruction Compliance | âœ… PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**This PR is ready for review and merge** âœ¨" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Quality gates failed
        if: needs.code-quality.result != 'success' || needs.test-coverage.result != 'success' || needs.security.result != 'success' || needs.build.result != 'success' || needs.instruction-compliance.result != 'success'
        run: |
          echo "### âŒ PR Quality Gates FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Gate | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality Standards | ${{ needs.code-quality.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Coverage (â‰¥80%) | ${{ needs.test-coverage.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Verification | ${{ needs.build.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Instruction Compliance | ${{ needs.instruction-compliance.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Please fix the failing quality gates before merging** âš ï¸" >> $GITHUB_STEP_SUMMARY
          exit 1
